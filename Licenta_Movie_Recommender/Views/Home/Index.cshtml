@model List<Licenta_Movie_Recommender.Models.Movie>
@{
    ViewData["Title"] = "Acasă";
    var userActivities = ViewBag.UserActivities as List<Licenta_Movie_Recommender.Models.UserMovieActivity> ?? new List<Licenta_Movie_Recommender.Models.UserMovieActivity>();
    var discoverMovies = ViewBag.DiscoverMovies as List<Licenta_Movie_Recommender.Models.Movie> ?? new List<Licenta_Movie_Recommender.Models.Movie>();
}

@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show mt-3 shadow-sm container" role="alert">
        <i class="bi bi-check-circle-fill me-2"></i> @TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="text-center mt-5 mb-5">
    <h1 class="display-4 fw-bold text-primary mb-3">Movie Recommender</h1>
    <p class="lead text-muted">Descoperă următoarele tale filme preferate.</p>
</div>

@* --- SECTIUNEA 1: RECOMANDARI --- *@
@if (User.Identity.IsAuthenticated)
{
    <div class="container mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
            <h3 class="fw-bold mb-0 text-light"><i class="bi bi-stars text-warning me-2"></i> Top Alegeri Pentru Tine</h3>
            @if (Model.Any())
            {
                <a asp-action="Recommendations" asp-controller="Movies" class="btn btn-sm btn-outline-danger">Vezi mai multe &raquo;</a>
            }
        </div>

        @if (!Model.Any())
        {
            <div class="alert bg-transparent border border-secondary shadow-sm text-center py-4 rounded-3 text-light">
                <i class="bi bi-film display-6 d-block mb-3 text-secondary opacity-50"></i>
                <h5 class="fw-bold">Deblochează Recomandările Inteligente</h5>
                <p class="text-muted mb-3 small">Evaluează cel puțin 5 filme pentru a ajuta algoritmul nostru să învețe ce îți place.</p>
            </div>
        }
        else
        {
            <div class="row">
                @foreach (var movie in Model)
                {
                    // Preluam starile filmului ca sa le trimitem la card
                    var activity = userActivities.FirstOrDefault(a => a.MovieId == movie.Id);
                    var inWatchlist = activity != null && activity.Status == 1 && activity.Rating == 0;
                    var isWatched = activity != null && (activity.Status == 2 || activity.Rating > 0);

                    <div class="col-lg-2 col-md-3 col-sm-4 col-6 mb-4">
                        <partial name="_MovieCard" model="movie" view-data='new ViewDataDictionary(ViewData) { { "InWatchlist", inWatchlist }, { "IsWatched", isWatched } }' />
                    </div>
                }
            </div>
        }
    </div>
}
else
{
    <div class="container text-center mb-5">
        <a asp-controller="Account" asp-action="Login" class="btn btn-danger px-4 shadow">Intră în cont</a>
        <a asp-controller="Account" asp-action="Register" class="btn btn-outline-secondary px-4 ms-2 shadow-sm">Creează cont</a>
    </div>
}

@* --- SECTIUNEA 2: DESCOPERA  --- *@
<div class="container mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
        <h3 class="fw-bold mb-0 text-light"><i class="bi bi-dice-5 me-2 text-primary"></i> Descoperă </h3>
        <div class="d-flex gap-2">
            <button type="button" id="btnRefreshDiscover" class="btn btn-sm btn-outline-secondary text-light" title="Aduce alte filme aleatorii">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
            <a asp-controller="Movies" asp-action="Index" class="btn btn-sm btn-secondary">Catalog &raquo;</a>
        </div>
    </div>

    <p class="text-muted mb-4 pb-2">Nu știi la ce să te uiți? Încearcă una dintre aceste sugestii surpriză extrase din catalogul nostru!</p>

    <div class="row" id="discoverGrid">
        @foreach (var movie in discoverMovies)
        {
            var activity = userActivities.FirstOrDefault(a => a.MovieId == movie.Id);
            var inWatchlist = activity != null && activity.Status == 1 && activity.Rating == 0;
            var isWatched = activity != null && (activity.Status == 2 || activity.Rating > 0);
            var isIgnored = activity != null && activity.Status == 3;

            // Ascundem daca a dat "ignora"
            if (isIgnored) continue;

            <div class="col-lg-2 col-md-3 col-sm-4 col-6 mb-4">
                <partial name="_MovieCard" model="movie" view-data='new ViewDataDictionary(ViewData) { { "InWatchlist", inWatchlist }, { "IsWatched", isWatched } }' />
            </div>
        }
    </div>
</div>

//refresh button
@section Scripts {
    <script>
        document.getElementById('btnRefreshDiscover')?.addEventListener('click', async function() {
            const btn = this;
            const originalHtml = btn.innerHTML;

            //loading animation
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            btn.disabled = true;

            try {
                
                const response = await fetch('/Home/Index?refreshDiscover=true');
                const htmlString = await response.text();

                
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlString, 'text/html');

                
                const newGrid = doc.getElementById('discoverGrid');

                
                if (newGrid) {
                    document.getElementById('discoverGrid').innerHTML = newGrid.innerHTML;
                }
            } catch (error) {
                console.error("Eroare la refresh-ul sectiunii descopera:", error);
            } finally {
                // 6. Punem butonul in starea initiala
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        });
    </script>
}