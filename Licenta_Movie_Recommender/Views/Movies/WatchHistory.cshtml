@{
    ViewData["Title"] = "Istoricul Meu";
}

<div class="container mt-4 mb-5">
    <div class="d-flex align-items-center mb-4 border-bottom pb-3">
        <h2 class="text-primary fw-bold mb-0"><i class="bi bi-clock-history me-2"></i> Activitatea Ta</h2>
        <a asp-action="MyProfile" class="btn btn-sm btn-outline-secondary ms-auto">&laquo; Înapoi la Profil</a>
    </div>

    <ul class="nav nav-pills nav-fill mb-4 bg-light rounded shadow-sm p-1" id="historyTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active fw-bold" id="watched-tab" data-bs-toggle="tab" data-bs-target="#watched" type="button" role="tab" onclick="switchTab(1)">
                <i class="bi bi-eye-fill"></i> Filme Văzute
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link fw-bold" id="watchlist-tab" data-bs-toggle="tab" data-bs-target="#watchlist" type="button" role="tab" onclick="switchTab(2)">
                <i class="bi bi-bookmark-fill"></i> Watchlist
            </button>
        </li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="watched" role="tabpanel">
            <div class="row" id="grid-1"></div>
            <div id="loader-1" class="text-center my-4" style="display:none;">
                <div class="spinner-border text-primary shadow-sm" role="status"></div>
                <div class="small text-muted mt-2 fw-bold">Încărcăm filmele...</div>
            </div>
        </div>

        <div class="tab-pane fade" id="watchlist" role="tabpanel">
            <div class="row" id="grid-2"></div>
            <div id="loader-2" class="text-center my-4" style="display:none;">
                <div class="spinner-border text-primary shadow-sm" role="status"></div>
                <div class="small text-muted mt-2 fw-bold">Încărcăm filmele...</div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // logica de infinite scroll
        let currentTab = 1;
        let pages = { 1: 1, 2: 1 };
        let hasMore = { 1: true, 2: true };
        let isLoading = false;

        
        function switchTab(tabId) {
            currentTab = tabId;
            if(pages[tabId] === 1 && hasMore[tabId]) {
                loadMore();
            }
        }

        
        async function loadMore() {
            if(isLoading || !hasMore[currentTab]) return;
            isLoading = true;

            let tab = currentTab;
            let page = pages[tab];

           
            document.getElementById('loader-' + tab).style.display = 'block';

            try {
                let response = await fetch(`/Movies/GetHistoryData?tab=${tab}&page=${page}`);
                let data = await response.json();

                if(data.length === 0) {
                    hasMore[tab] = false; // nu mai sunt filme
                    if(page === 1) {
                        document.getElementById('grid-' + tab).innerHTML = '<div class="col-12"><div class="alert alert-light border text-center py-4 text-muted">Nu există nicio activitate aici.</div></div>';
                    }
                } else {
                    let html = '';
                    data.forEach(movie => {
                        
                        let badge = '';
                        if(movie.rating > 0) badge = `<span class="position-absolute top-0 end-0 badge bg-warning text-dark m-1 shadow-sm"><i class="bi bi-star-fill"></i> ${movie.rating}</span>`;
                        else if (movie.status == 1) badge = `<span class="position-absolute top-0 end-0 badge bg-warning m-1 shadow-sm"><i class="bi bi-bookmark-fill"></i></span>`;
                        else badge = `<span class="position-absolute top-0 end-0 badge bg-success m-1 shadow-sm"><i class="bi bi-eye-fill"></i></span>`;

                        
                        html += `
                        <div class="col-md-2 col-sm-4 col-4 mb-4">
                            <a href="/Movies/Details/${movie.movieId}" class="text-decoration-none">
                                <div class="position-relative movie-card transition-hover">
                                    <img src="${movie.posterUrl}" class="img-fluid rounded shadow-sm" alt="${movie.title}" style="width: 100%; aspect-ratio: 2/3; object-fit: cover;" onerror="this.src='https://placehold.co/200x300?text=Fara+Poster'">
                                    ${badge}
                                </div>
                                <div class="small fw-bold text-dark mt-2 text-truncate" title="${movie.title}">${movie.title}</div>
                                <div class="text-muted" style="font-size: 0.75rem;"><i class="bi bi-calendar-event"></i> Adăugat: ${movie.dateAdded}</div>
                            </a>
                        </div>`;
                    });

                    
                    document.getElementById('grid-' + tab).insertAdjacentHTML('beforeend', html);
                    pages[tab]++; 
                }
            } catch (e) {
                console.error("Eroare la incarcarea filmelor: ", e);
            }

            document.getElementById('loader-' + tab).style.display = 'none';
            isLoading = false;
        }

        window.onload = () => {
            loadMore();
        };

        window.addEventListener('scroll', () => {
            if((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 400) {
                loadMore();
            }
        });
    </script>
}