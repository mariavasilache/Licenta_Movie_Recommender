@model Licenta_Movie_Recommender.Models.Movie

@{
    ViewData["Title"] = Model.Title;
}

@* --- MESAJE DE SUCCES / EROARE --- *@
<div id="alert-container">
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show mt-3 shadow-sm border-0" role="alert" style="background-color: rgba(25, 135, 84, 0.2); color: #75b798;">
            <i class="bi bi-check-circle-fill me-2"></i> @TempData["Success"]
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
</div>

<style>
    /* design sistem rating cu stelute  */
    .star-rating {
        display: flex;
        flex-direction: row-reverse;
        justify-content: flex-end;
    }

        .star-rating input {
            display: none;
        }

        .star-rating label {
            color: #555; 
            font-size: 2.2rem;
            padding: 0 5px;
            cursor: pointer;
            transition: color 0.2s, transform 0.2s;
        }

            .star-rating label:hover {
                transform: scale(1.1);
            }

                .star-rating input:checked ~ label,
                .star-rating label:hover,
                .star-rating label:hover ~ label {
                    color: #ffc107; 
                }

    /* Containerul principal*/
    .details-card {
        background-color: #1f1f1f;
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .action-card {
        background-color: #2b2b2b !important;
        border: 1px solid rgba(255, 255, 255, 0.05) !important;
    }
</style>

<div class="container mt-4 mb-5" id="main-details-container">

    @* --- HEADER CU BUTON DE INAPOI --- *@
    <partial name="_PageHeader" model='(string)ViewData["Title"]' />

    <div class="row details-card rounded shadow-lg p-4 g-4">

        @* --- POSTER --- *@
        <div class="col-md-4 text-center">
            <img src="@Model.PosterUrl"
                 class="img-fluid rounded shadow-lg border border-secondary"
                 alt="@Model.Title"
                 style="max-height: 550px; width: 100%; object-fit: cover; border-color: rgba(255,255,255,0.1) !important;"
                 onerror="this.src='https://placehold.co/400x600/2b2b2b/ffffff?text=@Uri.EscapeDataString(Model.Title)'" />
        </div>

        @* --- INFORMATII --- *@
        <div class="col-md-8">
            <h1 class="display-4 fw-bold mb-2 text-warning">@Model.Title</h1>

            <p class="text-muted fs-5">
                <i class="bi bi-calendar3 text-danger me-1"></i> Lansare: <span class="text-light">@(string.IsNullOrEmpty(ViewBag.ReleaseDate) ? "N/A" : ViewBag.ReleaseDate)</span> |
                <i class="bi bi-star-fill text-warning me-1"></i> TMDB: <span class="text-light">@(ViewBag.TmdbRating > 0 ? ((double)ViewBag.TmdbRating).ToString("0.0") : "N/A")</span> <small>/ 10</small>
            </p>

            <div class="mb-4 mt-3">
                @if (!string.IsNullOrEmpty(Model.Genres))
                {
                    @foreach (var gen in Model.Genres.Split('|'))
                    {
                        <span class="badge rounded-pill bg-dark border border-secondary me-2 fs-6 px-3 py-2 text-light">@gen</span>
                    }
                }
            </div>

            <h4 class="fw-bold text-warning border-bottom border-secondary pb-2 mb-3">Sinopsis</h4>
            <p class="lead text-light opacity-75" style="line-height: 1.8;">
                @ViewBag.Overview
            </p>

            @* --- ZONA ACTIUNI USER --- *@
            <div class="card action-card shadow-sm mt-5">
                <div class="card-body p-4">
                    @if (User.Identity.IsAuthenticated)
                    {
                        var rating = ViewBag.UserRating != null ? (int)ViewBag.UserRating : 0;
                        var status = ViewBag.UserStatus != null ? (int)ViewBag.UserStatus : 0;
                        var listsContainingMovie = ViewBag.ListsContainingMovie as List<int> ?? new List<int>();
                        var userLists = ViewBag.UserLists as List<Licenta_Movie_Recommender.Models.CustomList> ?? new List<Licenta_Movie_Recommender.Models.CustomList>();

                        @* RATING  *@
                        <div class="d-flex align-items-center justify-content-between mb-4 border-bottom border-secondary pb-3">
                            <form asp-action="SaveRating" method="post" class="m-0 d-flex align-items-center">
                                <input type="hidden" name="movieId" value="@Model.Id" />
                                <div class="star-rating me-3">
                                    @for (int i = 5; i >= 1; i--)
                                    {
                                        <input type="radio" id="star_@i" name="rating" value="@i" @(rating == i ? "checked" : "") class="ajax-rating" />
                                        <label for="star_@i" title="@i stele"><i class="bi bi-star-fill"></i></label>
                                    }
                                </div>
                                <span id="rating-badge-container">
                                    @if (rating > 0)
                                    {
                                        <span class="badge bg-warning text-dark fs-6 shadow-sm">Nota ta: @rating</span>
                                    }
                                </span>
                            </form>

                            @if (rating > 0)
                            {
                                <form asp-action="RemoveRatingOnly" method="post" class="m-0">
                                    <input type="hidden" name="movieId" value="@Model.Id" />
                                    <button type="submit" class="btn btn-sm btn-outline-danger border-0" title="Șterge nota">
                                        <i class="bi bi-trash3 fs-5"></i>
                                    </button>
                                </form>
                            }
                        </div>

                        @* BUTTONS  *@
                        <div class="d-flex flex-wrap gap-3" id="action-buttons-container">

                            @* Vizionat *@
                            @if (status == 2 || rating > 0)
                            {
                                <button type="button" class="btn btn-success px-4 fw-bold shadow" data-bs-toggle="modal" data-bs-target="#removeWatchedModal">
                                    <i class="bi bi-check-circle-fill me-2"></i> Vizionat
                                </button>
                            }
                            else
                            {
                                <form asp-action="MarkAsWatched" method="post" class="m-0">
                                    <input type="hidden" name="movieId" value="@Model.Id" />
                                    <button type="submit" class="btn btn-outline-success px-4 fw-bold"><i class="bi bi-eye me-2"></i> Marchează ca văzut</button>
                                </form>
                            }

                            @* Watchlist *@
                            @if (status == 1)
                            {
                                <form asp-action="RemoveActivityStatus" method="post" class="m-0">
                                    <input type="hidden" name="movieId" value="@Model.Id" />
                                    <button type="submit" class="btn btn-warning px-4 text-dark fw-bold shadow">
                                        <i class="bi bi-bookmark-check-fill me-2"></i> În Watchlist
                                    </button>
                                </form>
                            }
                            else
                            {
                                <form asp-action="AddToWatchlist" method="post" class="m-0">
                                    <input type="hidden" name="movieId" value="@Model.Id" />
                                    <button type="submit" class="btn btn-outline-warning px-4 fw-bold"><i class="bi bi-bookmark-plus me-2"></i> Watchlist</button>
                                </form>
                            }

                            @* Dropdown Liste *@
                            <div class="dropdown">
                                <button class="btn btn-outline-info px-4 fw-bold dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-folder-plus me-2"></i> Adaugă în listă
                                </button>
                                <ul class="dropdown-menu dropdown-menu-dark shadow-lg border-secondary" style="min-width: 280px;">
                                    <li>
                                        <button type="button" class="dropdown-item fw-bold text-info py-2" data-bs-toggle="modal" data-bs-target="#createListFromDetailsModal">
                                            <i class="bi bi-plus-circle-dotted me-2"></i> Creează listă nouă
                                        </button>
                                    </li>
                                    @if (userLists.Any())
                                    {
                                        <li><hr class="dropdown-divider border-secondary"></li>
                                        @foreach (var list in userLists)
                                        {
                                            var isInList = listsContainingMovie.Contains(list.Id);
                                            <li>
                                                <div class="dropdown-item d-flex justify-content-between align-items-center py-2">
                                                    <span class="text-truncate" style="max-width: 180px;">
                                                        @if (isInList)
                                                        {
                                                            <i class="bi bi-check2 text-success me-1"></i>
                                                        }
                                                        @list.Name
                                                    </span>
                                                    @if (isInList)
                                                    {
                                                        <form asp-action="RemoveMovieFromCustomList" method="post" class="m-0">
                                                            <input type="hidden" name="customListId" value="@list.Id" /><input type="hidden" name="movieId" value="@Model.Id" />
                                                            <button type="submit" class="btn btn-link text-danger p-0"><i class="bi bi-dash-circle"></i></button>
                                                        </form>
                                                    }
                                                    else
                                                    {
                                                        <form asp-action="AddMovieToCustomList" method="post" class="m-0">
                                                            <input type="hidden" name="customListId" value="@list.Id" /><input type="hidden" name="movieId" value="@Model.Id" />
                                                            <button type="submit" class="btn btn-link text-success p-0"><i class="bi bi-plus-circle"></i></button>
                                                        </form>
                                                    }
                                                </div>
                                            </li>
                                        }
                                    }
                                </ul>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-3">
                            <p class="text-muted mb-3 fs-5">Vrei să salvezi filmul sau să îi dai o notă?</p>
                            <a asp-controller="Account" asp-action="Login" class="btn btn-warning px-5 fw-bold text-dark">Autentifică-te acum</a>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="createListFromDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark border-secondary shadow-lg">
            <div class="modal-header border-secondary">
                <h5 class="modal-title fw-bold text-info">Listă nouă</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form asp-action="CreateCustomList" method="post">
                <input type="hidden" name="sourceMovieId" value="@Model.Id" />
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label text-muted small fw-bold">NUME LISTĂ</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary" name="name" required maxlength="100" placeholder="Ex: Favorite 2024">
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-muted small fw-bold">DESCRIERE (OPȚIONAL)</label>
                        <textarea class="form-control bg-dark text-white border-secondary" name="description" rows="2" maxlength="500"></textarea>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Anulează</button>
                    <button type="submit" class="btn btn-info px-4 fw-bold">Creează și adaugă</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="removeWatchedModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark border-danger shadow-lg">
            <div class="modal-header bg-danger text-white border-0">
                <h5 class="modal-title fw-bold">Atenție!</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body py-4 text-center">
                <i class="bi bi-exclamation-octagon text-danger display-4 mb-3 d-block"></i>
                <p class="fs-5 mb-0 text-light">Dacă anulezi vizionarea, <strong>nota acordată va fi ștearsă</strong>.</p>
                <p class="text-muted">Sigur vrei să continui?</p>
            </div>
            <div class="modal-footer border-0 justify-content-center pb-4">
                <button type="button" class="btn btn-outline-light px-4" data-bs-dismiss="modal">Nu, lasă așa</button>
                <form asp-action="RemoveActivityStatus" method="post" class="m-0">
                    <input type="hidden" name="movieId" value="@Model.Id" />
                    <button type="submit" class="btn btn-danger px-4 fw-bold">Da, șterge tot</button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // --- AJAX PENTRU BUTOANE WATCHLIST / VAZUT (FARA RELOAD!) ---
        document.querySelectorAll('#action-buttons-container form').forEach(form => {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                const btn = form.querySelector('button');
                const originalHtml = btn.innerHTML;
                const actionUrl = form.action;

                btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
                btn.disabled = true;

                try {
                    const response = await fetch(actionUrl, {
                        method: 'POST',
                        body: new FormData(form)
                    });

                    if (response.ok) {
                        if (actionUrl.includes('AddToWatchlist')) {
                            btn.className = 'btn btn-warning px-4 text-dark fw-bold shadow';
                            btn.innerHTML = '<i class="bi bi-bookmark-check-fill me-2"></i> În Watchlist';
                            form.action = '/Movies/RemoveActivityStatus';
                        }
                        else if (actionUrl.includes('MarkAsWatched')) {
                            btn.className = 'btn btn-success px-4 fw-bold shadow';
                            btn.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i> Vizionat';
                            form.action = '/Movies/RemoveActivityStatus';
                        }
                        else if (actionUrl.includes('RemoveActivityStatus')) {
                            if (btn.classList.contains('btn-warning')) {
                                btn.className = 'btn btn-outline-warning px-4 fw-bold';
                                btn.innerHTML = '<i class="bi bi-bookmark-plus me-2"></i> Watchlist';
                                form.action = '/Movies/AddToWatchlist';
                            } else {
                                btn.className = 'btn btn-outline-success px-4 fw-bold';
                                btn.innerHTML = '<i class="bi bi-eye me-2"></i> Marchează ca văzut';
                                form.action = '/Movies/MarkAsWatched';
                            }
                        }
                    }
                } catch (error) {
                    console.error("Eroare AJAX:", error);
                    btn.innerHTML = originalHtml;
                } finally {
                    btn.disabled = false;
                }
            });
        });

        // --- AJAX PENTRU RATING (STELUTE) ---
        document.querySelectorAll('.ajax-rating').forEach(input => {
            input.addEventListener('change', async (e) => {
                const selectedRating = e.target.value;
                const form = e.target.closest('form');

                try {
                    const response = await fetch(form.action, { method: 'POST', body: new FormData(form) });
                    if (response.ok) {
                        const badgeContainer = document.getElementById('rating-badge-container');
                        badgeContainer.innerHTML = `<span class="badge bg-warning text-dark fs-6 shadow-sm">Nota ta: ${selectedRating}</span>`;

                        showToast(`Ai acordat nota ${selectedRating}!`, 'success');
                    }
                } catch (error) { console.error("Eroare rating", error); }
            });
        });

        function showToast(message, type) {
            const toastHtml = `
                <div class="alert alert-${type} position-fixed top-0 start-50 translate-middle-x mt-4 shadow-lg border-0"
                     style="z-index: 9999; min-width: 250px; background-color: #198754; color: white;">
                    <i class="bi bi-check-circle-fill me-2"></i> ${message}
                </div>`;
            document.body.insertAdjacentHTML('afterbegin', toastHtml);
            const alert = document.querySelector('.alert');
            setTimeout(() => alert?.remove(), 2500);
        }
    </script>
}
}